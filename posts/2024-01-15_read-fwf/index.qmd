---
title: Read dirty tab-separated csv files
author:
  - name:
      given: Layal Christine
      family: Lettry
      orcid: 0009-0008-6396-0523
    affiliations:
      - id: cynkra
      - name: cynkra GmbH
        city: Zurich
        state: CH
      - id: unifr
      - name: University of Fribourg, Dept. of Informatics, ASAM Group
        city: Fribourg
        state: CH
date: 2024-01-15
categories: [readr, read_fwf, tab, csv]
image: image.jpg
citation: 
  url: https://rdiscovery.netlify.app/posts/2024-01-15_read-fwf/
format:
  html:
    toc: true
    toc-depth: 6
    toc-title: Contents
    toc-location: right
    number-sections: false
---

*What function could be used to read tab-separated csv files with values containing a tab?*

```{r}
#| label: table_diff
#| tbl-cap: "& and &&"
#| message: false
#| warning: false
#| echo: false
penguins_test_tab <- tibble::tribble(
  ~species, ~island, ~bill_length_mm, ~bill_depth_mm, ~flipper_length_mm, ~body_mass_g, ~sex, ~year,
  "Adelie", "Torgersen", "39.1", "18.7", "181", "3750", "male", "2007",
  "Adelie", "Tor gersen", "39.5", "17.4", "186", "3800", "female", "2007",
  "Adelie", "Torgersen", "40.3", "18", "195", "3250", "female", "2007",
  "Adelie", "Torgersen", "NA", "NA", "NA", "NA", "NA", "2007",
  "Adelie", "Torgersen", "test   tab", "19.3", "193", "3450", "female", "2007",
  "Adelie", "Torgersen", "39.3", "20.6", "190", "3650", "male", "2007",
  "Adelie", "Torgersen", "38.9", "17.8", "181", "3625", "female", "2007",
  "Adelie", "Torgersen", "39.2", "19.6", "195", "4675", "male", "2007",
  "Adelie", "Torgersen", "34.1", "18.1", "193", "3475", "NA", "2007",
  "Adelie", "Torgersen", "42", "20.2", "190", "4250", "NA", "2007",
  "Adelie", "Torgersen", "37.8", "17.1", "186", "3300", "NA", "2007",
  "Adelie", "Torgersen", "37.8", "17.3", "180", "3700", "NA", "2007",
  "Adelie", "Torgersen", "41.1", "17.6", "182", "3200", "female", "2007",
  "Adelie", "Torgersen", "38.6", "21.2", "191", "3800", "male", "2007",
  "Adelie", "Torgersen", "34.6", "21.1", "198", "4400", "male", "2007",
  "Adelie", "Torgersen", "36.6", "17.8", "185", "3700", "female", "2007",
  "Adelie", "Torgersen", "38.7", "19", "195", "3450", "female", "2007",
  "Adelie", "Torgersen", "42.5", "20.7", "197", "4500", "male", "2007",
  "Adelie", "Torgersen", "34.4", "18.4", "184", "3325", "female", "2007",
  "Adelie", "Torgersen", "46", "21.5", "194", "4200", "male", "2007",
  "Adelie", "Biscoe", "37.8", "18.3", "174", "3400", "female", "2007",
  "Adelie", "Bisc    oe", "37.7", "18.7", "180", "3600", "male", "2007",
  "Adelie", "Biscoe", "35.9", "19.2", "189", "3800", "female", "2007",
  "Adelie", "Biscoe", "38.2", "18.1", "185", "3950", "male", "2007",
  "Adelie", "Biscoe", "38.8", "17.2", "180", "3800", "male", "2007",
  "Adelie", "Biscoe", "35.3", "18.9", "187", "3800", "female", "2007",
  "Adelie", "Biscoe", "40.6", "18.6", "183", "3550", "male", "2007",
  "Adelie", "Biscoe", "40.5", "17.9", "187", "3200", "female", "2007",
  "Adelie", "Biscoe", "37.9", "18.6", "172", "3150", "female", "2007",
  "Adelie", "Biscoe", "40.5", "18.9", "180", "3950", "male", "2007",
  "Adelie", "Dream", "39.5", "16.7", "178", "3250", "female", "2007",
  "Adelie", "Dream", "37.2", "18.1", "178", "3900", "male", "2007",
  "Adelie", "Dream", "39.5", "17.8", "188", "3300", "female", "2007",
  "Adelie", "Dream", "40.9", "18.9", "184", "3900", "male", "2007",
  "Adelie", "Dream", "36.4", "17", "195", "3325", "female", "2007",
  "Adelie", "Dream", "39.2", "21.1", "196", "4150", "male", "2007",
  "Adelie", "Dream", "38.8", "20", "190", "3950", "male", "2007",
  "Adelie", "Dream", "42.2", "18.5", "180", "3550", "female", "2007",
  "Adelie", "Dream", "37.6", "19.3", "181", "3300", "female", "2007",
  "Adelie", "Dream", "39.8", "19.1", "184", "4650", "male", "2007",
  "Adelie", "Dream", "36.5", "18", "182", "3150", "female", "2007",
  "Adelie", "Dream", "40.8", "18.4", "195", "3900", "male", "2007",
  "Adelie", "Dream", "36", "18.5", "186", "3100", "female", "2007",
  "Adelie", "Dream", "44.1", "19.7", "196", "4400", "male", "2007",
  "Adelie", "Dream", "37", "16.9", "185", "3000", "female", "2007",
  "Adelie", "Dream", "39.6", "18.8", "190", "4600", "male", "2007",
  "Adelie", "Dream", "41.1", "19", "182", "3425", "male", "2007",
  "Adelie", "Dream", "37.5", "18.9", "179", "2975", "NA", "2007",
  "Adelie", "Dream", "36", "17.9", "190", "3450", "female", "2007",
  "Adelie", "Dream", "42.3", "21.2", "191", "4150", "male", "2007"
)
path <- tempfile(fileext = ".csv")
readr::write_delim(penguins_test_tab, path, delim = "\t")

library(tidyverse)

file <- path
file_encoding <-
  guess_encoding(file) |>
  pull(encoding)

raw_data <-
  read_fwf(
    file,
    col_types = cols(.default = col_character()),
    locale = locale(encoding = file_encoding),
    skip = 1L
  )

headers <- strsplit(readLines(file, n = 1L), "\t")[[1]]
col_names <- gsub("\"", "", headers)

out <- raw_data |>
  separate_wider_delim(
    cols = X1,
    names = col_names,
    delim = "\t",
    too_many = "merge" # due to some comments in the VALUE column that contain a tab, which creates a wrong new column
  ) |>
  mutate(
    across(everything(), \(x) gsub('"', "", x))
  )

raw_dirty <- out |>
  mutate(
    bill_length_mm = as.double(bill_length_mm),
    bill_depth_mm = as.double(bill_depth_mm),
    flipper_length_mm = as.double(flipper_length_mm),
    body_mass_g = as.double(body_mass_g),
    year = as.integer(body_mass_g)
  )
#> Warning: There were 4 warnings in `mutate()`.
#> The first warning was:
#> ℹ In argument: `bill_length_mm = as.double(bill_length_mm)`.
#> Caused by warning:
#> ! NAs introduced by coercion
#> ℹ Run `dplyr::last_dplyr_warnings()` to see the 3 remaining warnings.

raw_clean <- janitor::clean_names(raw_dirty)

raw_clean
#> # A tibble: 50 × 8
#>    species island     bill_length_mm bill_depth_mm flipper_length_mm body_mass_g
#>    <chr>   <chr>               <dbl>         <dbl>             <dbl>       <dbl>
#>  1 Adelie  Torgersen            39.1          18.7               181        3750
#>  2 Adelie  Tor gersen           39.5          17.4               186        3800
#>  3 Adelie  Torgersen            40.3          18                 195        3250
#>  4 Adelie  Torgersen            NA            NA                  NA          NA
#>  5 Adelie  Torgersen            NA            19.3               193        3450
#>  6 Adelie  Torgersen            39.3          20.6               190        3650
#>  7 Adelie  Torgersen            38.9          17.8               181        3625
#>  8 Adelie  Torgersen            39.2          19.6               195        4675
#>  9 Adelie  Torgersen            34.1          18.1               193        3475
#> 10 Adelie  Torgersen            42            20.2               190        4250
#> # ℹ 40 more rows
#> # ℹ 2 more variables: sex <chr>, year <int>
```

